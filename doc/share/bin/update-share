#! /bin/sh

export LC_ALL=C

set -e
url='https://svn.lrde.epita.fr/svn/lrde-publis/trunk'
me=$(basename $0)

## BEGIN
#    update-share [-h]  [DIR = .]
#
# Run this program when you are inside the publication directory
# to refresh the use of the share directory for its most up to date
# revision.  Note that it hard codes this revision, to avoid
# backward compatibility issues.
#
# -h, --help               display this message and exit
## END

stderr ()
{
    echo >&2 "$me: $@"
}

fatal ()
{
    stderr "$@"
    exit 1
}

for arg
do
  case $arg in
      -h | --help )
	  sed -rn '/^## BEGIN/,/^## END/{s/^# ?//;/^#/!p}' $0
	  exit 0
	  ;;
      *)
	  fatal "unexpected argument: $0"
	  ;;
  esac
done

set -x

: ${tasks="update"}

# grep -v may exit with failure.
externals=$(svn propget svn:externals "." | sed  '/^share/d')
rev=$(svn info $url/share | sed -n 's/Revision *: *//p')
if test -z "$rev"; then
  fatal "cannot fetch the revision of $url/share"
fi

set -x

for task in $tasks
do
    case $task in
	(update) # Update share/.
	externals="share -r $rev $url/share
$externals"
	svn propset svn:externals "$externals" .
	svn up
	;;

	(*)
	fatal "unknown task: $task"
	;;
    esac
done

set +x

stderr "You should checkin the host project, share/ was updated."
